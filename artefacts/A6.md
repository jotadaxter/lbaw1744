# A6: Indexes, triggers, user functions and population
 
## 1. Database Workload
 
> A study of the predicted system load (database load), organized in subsections.
 
### 1.1. Tuple Estimation
 
> Estimate of tuples at each relation.
 
| Relation Reference | Relation  Name          | Order of Magnitude | Estimated Growth |
|--------------------|-------------------------|--------------------|------------------|
| R01                | User                    | tens               | units per day    |
| R02                | Seller                  | tens               | units per day    |
| R03                | Product                 | thousands          | dozens per day   |
| R04                | Discount                | thousands          | dozens per day   |
| R05                | SerialKey               | thousands          | dozens per day   |
| R06                | Purchase                | thousands          | dozens per day   |
| R07                | Review                  | hundreds           | units per day    |
| R08                | Wishlist                | hundreds           | units per day    |
| R09                | Tag                     | tens               | units per day    |
| R10                | Image                   | hundreds           | dozens per day   |
| R11                | Product_Tag             | tends              | units per day    |
| R12                | Purchase_Product        | thousands          | dozens per day   |

### 1.2. Frequent Queries

> Most important queries (SELECT) and their frequency.

| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT01_                               |
| __Query description__ | User's Info                       |
| __Query frequency__   | hundreds per day                   |
| __SQL__ |  ```SQL SELECT * FROM "Users" WHERE "Users".username = $userName; ```     |

| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT02_                               |
| __Query description__ | Product Info                       |
| __Query frequency__   | hundreds per day                   |
| __SQL__ |```SQL  SELECT * FROM "Products" WHERE "Products".product_id = $productId; ```          |

| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT03_                               |
| __Query description__ | User's Wishlist                      |
| __Query frequency__   | dozens per day                   |
| __SQL__ |```SQL SELECT * FROM "Products" INNER JOIN "Wishlists" ON "Wishlists".product_id = "Products".product_id WHERE "Wishlists".user_id = $userId; ```          |

| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT04_                               |
| __Query description__ | User's Purchased Products                    |
| __Query frequency__   | dozens per day                   |
| __SQL__ |```SQL  SELECT * FROM "Products" WHERE "Products".product_id IN ( SELECT DISTINCT product_id FROM (("PurchasedKeys" INNER JOIN "Purchases" ON "PurchasedKeys".purchase_id = "Purchases".purchase_id)	INNER JOIN "SerialKeys" ON "PurchasedKeys".sk_id = "SerialKeys".sk_id) WHERE "Purchases".user_id = $userId); ```          |
 
| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT05_                               |
| __Query description__ | Search for product by name or tag                      |
| __Query frequency__   | hundreds per day                   |
| __SQL__ |```SQL  SELECT * FROM "Products" WHERE "Products".name LIKE '%$search%' OR EXISTS ( SELECT "Tags".tag_name FROM "Tags" WHERE "Products".product_id = "Tags".product_id AND "Tags".tag_name LIKE '%$search%') ORDER BY "Products".name ASC; ```          |

| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT06_                               |
| __Query description__ | Search for product reviews, including reviewer's ID                    |
| __Query frequency__   | dozens per day                   |
| __SQL__ |```SQL  SELECT "Reviews".rating, "Reviews".comment, "Reviews".review_date, "Users".username, "Users".img, "Users".user_id FROM (("Reviews" INNER JOIN "SerialKeys" ON "SerialKeys".sk_id = "Reviews".sk_id) INNER JOIN "Users" ON "SerialKeys".user_id = "Users".user_id) WHERE "SerialKeys".product_id = $productId ORDER BY "Reviews".rating DESC;  ```          |
 
 | Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT07_                               |
| __Query description__ | Pre-login Handshake (through username, e-mail or phone number)                      |
| __Query frequency__   | hundreds per day                   |
| __SQL__ |```SQL SELECT "Users".username, "Users".password FROM "Users" WHERE "Users".username = $idText OR "Users".email = $idText; ```          |
 
  | Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT08_                               |
| __Query description__ | Product's images                      |
| __Query frequency__   | dozens per day                   |
| __SQL__ |```SQL      SELECT "ProductImages".img_path FROM "ProductImages" WHERE "ProductImages".product_id = $productId; ```    |
 
 | Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT09_                               |
| __Query description__ | Get product's overall rating                      |
| __Query frequency__   | dozens per day                   |
| __SQL__ |```SQL   SELECT AVG("Reviews".rating) FROM "Reviews" INNER JOIN "SerialKeys" ON "SerialKeys".sk_id = "Reviews".sk_id WHERE "SerialKeys".product_id = $productId;    ```          | 
 
 | Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT10_                               |
| __Query description__ | Most Trending Products in the last "trendTime" days       |
| __Query frequency__   | dozens per day                   |
| __SQL__ |```SQL  SELECT * FROM "Products" WHERE "Products".product_id IN ( SELECT product_id FROM ( SELECT "SerialKeys".product_id, COUNT(*) FROM (("PurchasedKeys" INNER JOIN "SerialKeys" ON "PurchasedKeys".sk_id = "SerialKeys".sk_id) INNER JOIN "Purchases" ON "PurchasedKeys".purchase_id = "Purchases".purchase_id) WHERE "SerialKeys".product_id = "Products".product_id AND "Purchases".paid_date >= NOW() - INTERVAL '$trendTime day' GROUP BY "SerialKeys".product_id ORDER BY 2 DESC) AS DERP )  ```          | 

 | Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | _SELECT11_                               |
| __Query description__ | Get product's with discounts                     |
| __Query frequency__   | thousands per day                   |
| __SQL__ |```SQL SELECT product_id FROM "Discounts" WHERE (CURRENT_DATE BETWEEN "Discounts".begin_date AND "Discounts".end_date); ``` | 
 
### 1.3. Frequent Updates
 
> Most important updates (INSERT, UPDATE, DELETE) and their frequency.
 
| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | UPDATE01                              |
| __Query description__ | Update User Information                      |
| __Query frequency__   | hundreds per month                   |
| __SQL__ |```SQL    UPDATE "Users" SET email = $email, username = $username, fullname = $fullname WHERE id = $id;    ```          |

| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | UPDATE02                              |
| __Query description__ | Update Password for User                    |
| __Query frequency__   | dozens per day                   |
| __SQL__ |```SQL    UPDATE "Users" SET password = $new_password WHERE id = $id AND password = $old_password;    ```          |
 
| Title | Explain| 
| --------------------- | -------------------------------------- |
| __Query reference__   | UPDATE03                              |
| __Query description__ | Update Product                    |
| __Query frequency__   | dozens per day                   |
| __SQL__ |```SQL    UPDATE "Products" SET description = $description, price = $price WHERE product_id = $productId AND seller_id = $sellerId;    ```          | 
 
## 2. Proposed Indices
 
### 2.1. Performance Indices
 
> Indices proposed to improve performance of the identified queries.
 
| Index reference | IDX01                                  |
| --------------- | -------------------------------------- |
| Related queries | SELECT01, SELECT07                      |
| Index relation  | Users   				 |
| Index attribute | username   				|
| Index type      | Hash            			 |
| Cardinality | High |
| Clustering      | No              |
| Justification   | Query SELECT01 and SELECT07 has to be fast as it is executed many times; doesn't need range query support; cardinality is high because username of the user is an unique key; it's not a good candidate for clustering.   |
| SQL code        | ``` CREATE INDEX username_user ON "Users" USING hash (lower(username)); ``` |

| Index reference | IDX02                                  |
| --------------- | -------------------------------------- |
| Related queries | SELECT02                     |
| Index relation  | Products  				 |
| Index attribute | product_id   				|
| Index type      | Hash            			 |
| Cardinality | High |
| Clustering      | No              |
| Justification   | Table is very large; query SELECT02, used to search the products, has to be fast because it's executed many times; doesn't need range query support;  it's not a good candidate for clustering.   |
| SQL code        | ``` CREATE INDEX product ON "Products" USING hash (product_id); ``` |

| Index reference | IDX03                                  |
| --------------- | -------------------------------------- |
| Related queries | SELECT11                     |
| Index relation  | Discounts  				 |
| Index attribute | begin_date  				|
| Index type      | B-tree            			 |
| Cardinality | Medium |
| Clustering      | Yes              |
| Justification   | Table is very large; query SELECT11, used to search the products with discounts, It's clustered to allow for quick range queries; cardinality is medium  |
| SQL code        | ``` CREATE INDEX promotions ON "Discounts" (begin_date) WHERE (CURRENT_DATE BETWEEN "Discounts".begin_date AND "Discounts".end_date); ``` |
 
 
### 2.2. Full-text Search Indices 
 
> The system being developed must provide full-text search features supported by PostgreSQL. Thus, it is necessary to specify the fields where full-text search will be available and the associated setup, namely all necessary configurations, indexes definitions and other relevant details.
 
| Index reference | IDX04                                  |
| --------------- | -------------------------------------- |
| Related queries | SELECT05                        |
| Index relation  | Products  				 |
| Index attribute | name   				|
| Index type      | GiST           			 |
| Clustering      | No              |
| Cardinality | High |
| Justification   | To improve the performance of search when searching for the name of the products; GiST because it's better for dynamic data.   |
| SQL code        | ``` CREATE INDEX search_name ON Products USING GIST (to_tsvector('english', name) ``` |
 
 
## 3. Triggers
 
> User-defined functions and trigger procedures that add control structures to the SQL language or perform complex computations, are identified and described to be trusted by the database server. Every kind of function (SQL functions, Stored procedures, Trigger procedures) can take base types, composite types, or combinations of these as arguments (parameters). In addition, every kind of function can return a base type or a composite type. Functions can also be defined to return sets of base or composite values.
 
| Trigger reference   | TRIGGER01                                                               |
| Trigger description | Trigger description, including reference to the business rules involved |
| ------------------- | ----------------------------------------------------------------------- |
| SQL code                                                                                      |
 
 
## 4. Complete SQL Code
 
> The database script must also include the SQL to populate a database with test data with an amount of tuples suitable for testing and with plausible values for the fields of the database.
> This code should also be included in the group's github repository as an SQL script, and a link include here.

(https://github.com/jotadaxter/lbaw1744/blob/master/artefacts/queries.sql "Queries")
(https://github.com/jotadaxter/lbaw1744/blob/master/artefacts/database.sql "Database")
(https://github.com/jotadaxter/lbaw1744/blob/master/artefacts/populate.sql "Populate")
(https://github.com/jotadaxter/lbaw1744/blob/master/artefacts/indexes.sql "Indexes")
(https://github.com/jotadaxter/lbaw1744/blob/master/artefacts/triggers.sql "Triggers")

```SQL
--Database--

DROP SCHEMA IF EXISTS public CASCADE;
CREATE SCHEMA public AUTHORIZATION lbaw1744;

CREATE TYPE paymentmethod AS ENUM (
    'Credit Card',
    'PayPal',
    'Banking Transfer'
);


CREATE TYPE userstate AS ENUM (
    'Active',
    'Inactive',
    'Blocked',
    'Banned'
);


	-- Tables

CREATE TABLE "Discounts" (
    product_id integer NOT NULL,
    discounted_price double precision NOT NULL,
    begin_date timestamp with time zone DEFAULT now() NOT NULL,
    end_date timestamp with time zone NOT NULL,
    CONSTRAINT "Discounts_check" CHECK (end_date > begin_date),
    CONSTRAINT "Discounts_discounted_price_check" CHECK (discounted_price >= 0.)
);


CREATE TABLE "ProductImages" (
    product_id integer NOT NULL,
    img_path text NOT NULL
);


CREATE TABLE "Products" (
    product_id SERIAL NOT NULL,
    user_id integer NOT NULL,
    description text NOT NULL,
    release_date timestamp with time zone NOT NULL,
    operating_system text NOT NULL,
    price double precision NOT NULL,
    logo_path text NOT NULL,
    name text NOT NULL,
    CONSTRAINT "Products_price_check" CHECK (price >= 0.)
);


CREATE TABLE "Purchases" (
    purchase_id SERIAL NOT NULL,
    final_price double precision NOT NULL,
    user_id integer NOT NULL,
    paid_date timestamp with time zone DEFAULT now() NOT NULL,
    payment_method paymentmethod,
    details text,
    CONSTRAINT "Payments_check" CHECK ((final_price > 0. AND payment_method <> NULL) OR (final_price = 0. AND payment_method = NULL))
);


CREATE TABLE "Reviews" (
	sk_id integer NOT NULL,
    rating integer NOT NULL,
    review_date timestamp with time zone DEFAULT now() NOT NULL,
    "comment" text
);


CREATE TABLE "Sellers" (
    user_id integer NOT NULL,
    professional_email text NOT NULL,
    professional_name text NOT NULL,
    professional_phone integer NOT NULL
);


CREATE TABLE "SerialKeys" (
	sk_id SERIAL NOT NULL,
    user_id integer,
    product_id integer NOT NULL,
    code text NOT NULL
);


CREATE TABLE "Tags" (
    product_id SERIAL NOT NULL,
    tag_name text NOT NULL
);


CREATE TABLE "Users" (
    user_id SERIAL NOT NULL,
    username text NOT NULL,
    password text NOT NULL,
    fullname text,
    email text NOT NULL,
    phone_number integer,
    birth_date timestamp with time zone NOT NULL,
    admission_date timestamp with time zone DEFAULT now() NOT NULL,
    "state" userstate DEFAULT 'Active' NOT NULL,
    "admin" boolean DEFAULT false NOT NULL,
    img text,
    nif integer
);


CREATE TABLE "Wishlists" (
    user_id integer NOT NULL,
    product_id integer NOT NULL
);

CREATE TABLE "PurchasedKeys" (
    sk_id integer NOT NULL,
    purchase_id integer NOT NULL,
    price double precision NOT NULL
);



	-- Primary Keys and Uniques


ALTER TABLE ONLY "Discounts"
    ADD CONSTRAINT "Discounts_pkey" PRIMARY KEY (product_id);


ALTER TABLE ONLY "ProductImages"
    ADD CONSTRAINT "ProductImages_pkey" PRIMARY KEY (product_id, img_path);


ALTER TABLE ONLY "Products"
    ADD CONSTRAINT "Products_name_key" UNIQUE (name);


ALTER TABLE ONLY "Products"
    ADD CONSTRAINT "Products_pkey" PRIMARY KEY (product_id);


ALTER TABLE ONLY "Purchases"
    ADD CONSTRAINT "Purchases_pkey" PRIMARY KEY (purchase_id);


ALTER TABLE ONLY "Reviews"
    ADD CONSTRAINT "Reviews_pkey" PRIMARY KEY (sk_id);

ALTER TABLE ONLY "Sellers"
    ADD CONSTRAINT "Sellers_pkey" PRIMARY KEY (user_id);


ALTER TABLE ONLY "Sellers"
    ADD CONSTRAINT "Sellers_professional_email_key" UNIQUE (professional_email);


ALTER TABLE ONLY "Sellers"
    ADD CONSTRAINT "Sellers_user_id_key" UNIQUE (user_id);


ALTER TABLE ONLY "SerialKeys"
    ADD CONSTRAINT "SerialKeys_pkey" PRIMARY KEY (sk_id);


ALTER TABLE ONLY "Tags"
    ADD CONSTRAINT "Tags_pkey" PRIMARY KEY (product_id, tag_name);


ALTER TABLE ONLY "Users"
    ADD CONSTRAINT "Users_email_key" UNIQUE (email);


ALTER TABLE ONLY "Users"
    ADD CONSTRAINT "Users_pkey" PRIMARY KEY (user_id);


ALTER TABLE ONLY "Users"
    ADD CONSTRAINT "Users_username_key" UNIQUE (username);


ALTER TABLE ONLY "Wishlists"
    ADD CONSTRAINT "Wishlists_pkey" PRIMARY KEY (user_id, product_id);


ALTER TABLE ONLY "PurchasedKeys"
    ADD CONSTRAINT "PurchasedKeys_pkey" PRIMARY KEY (sk_id, purchase_id);



	-- Foreign Keys


ALTER TABLE ONLY "ProductImages"
    ADD CONSTRAINT "ProductImages_product_id_fkey" FOREIGN KEY (product_id) REFERENCES "Products"(product_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "Products"
    ADD CONSTRAINT "Products_user_id_fkey" FOREIGN KEY (user_id) REFERENCES "Sellers"(user_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "Purchases"
    ADD CONSTRAINT "Purchases_user_id_fkey" FOREIGN KEY (user_id) REFERENCES "Users"(user_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "Reviews"
    ADD CONSTRAINT "Reviews_purchase_id_fkey" FOREIGN KEY (sk_id) REFERENCES "SerialKeys"(sk_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "Sellers"
    ADD CONSTRAINT "Sellers_user_id_fkey" FOREIGN KEY (user_id) REFERENCES "Users"(user_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "SerialKeys"
    ADD CONSTRAINT "SerialKeys_user_id_fkey" FOREIGN KEY (user_id) REFERENCES "Users"(user_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "SerialKeys"
    ADD CONSTRAINT "SerialKeys_product_id_fkey" FOREIGN KEY (product_id) REFERENCES "Products"(product_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "Tags"
    ADD CONSTRAINT "Tags_product_id_fkey" FOREIGN KEY (product_id) REFERENCES "Products"(product_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "Wishlists"
    ADD CONSTRAINT "Wishlists_product_id_fkey" FOREIGN KEY (product_id) REFERENCES "Products"(product_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "Wishlists"
    ADD CONSTRAINT "Wishlists_user_id_fkey" FOREIGN KEY (user_id) REFERENCES "Users"(user_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "PurchasedKeys"
    ADD CONSTRAINT "PurchasedKeys_sk_id_fkey" FOREIGN KEY (sk_id) REFERENCES "SerialKeys"(sk_id) ON UPDATE CASCADE;


ALTER TABLE ONLY "PurchasedKeys"
    ADD CONSTRAINT "PurchasedKeys_purchase_id_fkey" FOREIGN KEY (purchase_id) REFERENCES "Purchases"(purchase_id) ON UPDATE CASCADE;
    
    
--Populate--

--deletes
DELETE FROM "Users";
DELETE FROM "Sellers";
DELETE FROM "Products";
DELETE FROM "Discounts";
DELETE FROM "Purchases";
DELETE FROM "Reviews";
DELETE FROM "Wishlists";
DELETE FROM "ProductImages";
DELETE FROM "Tags";
DELETE FROM "SerialKeys";

-- Users (user_id, username, password, fullname, email, phone_number, birth_date, admission_date, userstate, admin, img, nif)
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(100, 'janedoe1', 'cheekybreeky', 'jane eleanor doer', 969420666, 'janedoe@gmail.com', '1988/11/18', '2018/3/20', 'Active', false, 'janeavatar.jpg', 666420666);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(101, 'jenlong', 'oblivion', 'jenny long', 911999333, 'jenny.long84@example.com', '1973/7/10', '2018/2/20', 'Active', false, 'jenavatar.jpg', 666420777);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(102, 'everettdotnet', 'morrowind', 'everett adams', 969420444, 'everett.adams60@example.com', '1980/3/8', '2018/1/10', 'Active', false, 'eveavatar.jpg', 666420888);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(103, 'zdaroviaqueen', 'zdarovia', 'regina duncan', 969420555, 'regina.duncan44@example.com', '1990/1/1', '2018/3/11', 'Active', false, 'regavatar.jpg', 666420999);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(104, 'kentron', 'notoriousbig', 'ken gonzalez', 969420777, 'ken.gonzalez84@example.com', '1994/4/4', '2018/1/18', 'Active', false, 'tedavatar.jpg', 666421000);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(105, 'teddyboy', 'yeezytaughtme', 'ted mitchell', 969420888, 'ted.mitchell70@example.com', '1988/11/18', '2018/3/20', 'Active', false, 'janeavatar.jpg', 666421111);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(106, 'nottheactor', 'hoffhoff', 'dustin hoffman', 969420999, 'dustin.hoffman16@example.com', '1987/9/19', '2018/6/21', 'Active', false, 'dustavatar.jpg', 666421222);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(107, 'desugurippu', 'noided', 'michael arnold', 969420111, 'michael.arnold30@example.com', '1984/8/7', '2018/3/22', 'Active', false, 'micavatar.jpg', 666421333);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(108, 'normac', 'cardibandrum', 'norma cooper', 969420222, 'norma.cooper92@example.com', '1999/12/28', '2018/1/4', 'Active', false, 'normavatar.jpg', 666421444);
INSERT INTO "Users"(user_id, username, password, fullname, phone_number, email, birth_date, admission_date, state, admin, img, nif) VALUES(109, 'lilnina', 'groovey', 'nina sutton', 969420333, 'nina.sutton76@example.com', '1997/10/9', '2018/2/3', 'Active', false, 'ninavatar.jpg', 666421555);

-- Sellers (user_id, professional_email, professional_name, professional_phone)
INSERT INTO "Sellers"(user_id, professional_email, professional_name, professional_phone) VALUES (105, 'ableton@gmail.com', 'ableton', 912345678);
INSERT INTO "Sellers"(user_id, professional_email, professional_name, professional_phone) VALUES (106, 'adobe@gmail.com', 'adobe', 913456789);
INSERT INTO "Sellers"(user_id, professional_email, professional_name, professional_phone) VALUES (107, 'microsoft@gmail.com', 'microsoft', 912543876);
INSERT INTO "Sellers"(user_id, professional_email, professional_name, professional_phone) VALUES (108, 'sony@gmail.com', 'sony', 913654987);
INSERT INTO "Sellers"(user_id, professional_email, professional_name, professional_phone) VALUES (109, 'blender@gmail.com', 'blender', 919876543);

-- Products (product_id, user_id, description, release_date, operating_system, price, logo_path, name)
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (200, 105, 'daw for live mixing and production', '2015/10/20', 'wml', 599, 'ableton9.jpg', 'ableton 9 live suite');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (201, 106, 'image editing software', '2016/2/14', 'wml', 599, 'photoshop.jpg', 'adobe photoshop');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (202, 107, 'programming ide', '2018/3/12', 'w', 199, 'visualstudio.jpg', 'visual studio 2018');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (203, 108, 'video editing software', '2014/1/22', 'wm', 299, 'sonyvegas.jpg', 'sony vegas pro');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (204, 109, '3d rendering and editing software', '2013/10/12', 'wml', 0, 'blender.jpg', 'blender');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (205, 105, 'synthetizer plug in for ableton', '2017/11/21', 'wml', 29, 'massive.jpg', 'ableton massive plugin');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (206, 106, 'vector graphic design software', '2016/4/1', 'wml', 99, 'ilustrator.jpg', 'adobe ilustrator');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (207, 107, 'programming text editor', '2017/11/10', 'w', 0, 'visualcode.jpg', 'microsoft visual code');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (208, 108, 'digital audio editing suite software', '2002/7/12', 'wm', 199, 'soundforge.jpg', 'sony sound forge');
INSERT INTO "Products" (product_id, user_id, description, release_date, operating_system, price, logo_path, name) VALUES (209, 109, 'dynamic mixing device', '2018/10/9', 'wml', 99, 'channelblender.jpg', 'channel blender');

-- Product Images (product_id, img_path)
INSERT INTO "ProductImages"(product_id, img_path) VALUES (200, 'abletonimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (201, 'photoshopimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (202, 'visualstudioimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (203, 'sonyvegasimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (204, 'blenderimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (205, 'massiveimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (206, 'ilustratorimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (207, 'visualcodeimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (208, 'soundforgeimg1.jpg');
INSERT INTO "ProductImages"(product_id, img_path) VALUES (209, 'channelblenderimg1.jpg');

-- Tags (product_id, tag_name)
INSERT INTO "Tags"(product_id, tag_name) VALUES (200, 'daw');
INSERT INTO "Tags"(product_id, tag_name) VALUES (201, 'image');
INSERT INTO "Tags"(product_id, tag_name) VALUES (202, 'programming');
INSERT INTO "Tags"(product_id, tag_name) VALUES (203, 'video');
INSERT INTO "Tags"(product_id, tag_name) VALUES (204, '3d');
INSERT INTO "Tags"(product_id, tag_name) VALUES (205, 'audio');
INSERT INTO "Tags"(product_id, tag_name) VALUES (206, 'design');
INSERT INTO "Tags"(product_id, tag_name) VALUES (207, 'text');
INSERT INTO "Tags"(product_id, tag_name) VALUES (208, 'audio');
INSERT INTO "Tags"(product_id, tag_name) VALUES (209, '3d');

-- SerialKeys (sk_id, user_id, product_id, code)
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (500, 105, 200, '1J6B5JHG7I');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (501, 106, 201, '0FIAJ5N6B3');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (502, 107, 202, '09FUHRB5N6');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (503, 108, 203, 'S0HNS4K6HS');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (504, 109, 204, 'OFCJAGHI54');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (505, 105, 205, '0SAIDUFRKF');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (506, 106, 206, 'SGHUDIFOG3');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (507, 107, 207, '5URJEDKHA4');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (508, 108, 208, '38HUEDWXJH');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (509, 109, 209, 'IODIGHOI2N');
INSERT INTO "SerialKeys"(sk_id, user_id, product_id, code) VALUES (510, 109, 209, 'IODIGHOP2N');


-- Reviews (sk_id, rating, review_date, comment)
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (500, 4, '2018/3/1', 'very good product although a tad expensive');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (501, 5, '2017/4/12', 'i am amazed at this product it is very nice');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (502, 5, '2018/10/25', 'this is an incredible piece of software');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (503, 4, '2017/6/15', 'the product fulfills its purpose with precision');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (504, 3, '2018/2/5', 'hey thats pretty good');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (505, 5, '2018/8/14', 'i am astonished at how efficient this product is');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (506, 2, '2018/4/22', 'way too expensive for the amount of features it comes with');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (507, 4, '2017/10/30', 'way too cheap for the amount of features it comes with');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (508, 1, '2016/7/6', 'absolutely atrocious, barely works, cant even install it');
INSERT INTO "Reviews"(sk_id, rating, review_date, comment) VALUES (509, 3, '2018/12/14', 'its nice but there are way better options out there');

-- Discounts (product_id, discounted_rice, begin_date, end_date)
INSERT INTO "Discounts"(product_id, discounted_price, begin_date, end_date) VALUES (200, 20, '2018/5/10', '2018/5/20');
INSERT INTO "Discounts"(product_id, discounted_price, begin_date, end_date) VALUES (201, 20, '2018/5/10', '2018/5/20');
INSERT INTO "Discounts"(product_id, discounted_price, begin_date, end_date) VALUES (202, 30, '2018/5/10', '2018/5/20');
INSERT INTO "Discounts"(product_id, discounted_price, begin_date, end_date) VALUES (203, 20, '2018/12/1', '2019/1/4');
INSERT INTO "Discounts"(product_id, discounted_price, begin_date, end_date) VALUES (204, 15, '2018/4/1', '2018/4/30');

-- Purchases (purchase_id, final_price, user_id, sk_id, paid_date, paymentmethod, details)
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (800, 579, 100, '2018/4/21', 'Credit Card', 'Purchase successful');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (801, 579, 101, '2018/6/12', 'Credit Card', 'Purchase successful');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (802, 169, 102, '2018/5/2', 'PayPal', 'Minor setbacks contacting seller');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (803, 279, 103, '2018/6/23', 'Banking Transfer', 'Purchase successful');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (804, 14, 104, '2018/3/31', 'Banking Transfer', 'Minor setbacks contacting seller');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (805, 29, 100, '2018/1/26', 'Credit Card', 'Purchase sucessful');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (806, 99, 101, '2018/8/1', 'PayPal', 'Purchase successful');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (807, 579, 102, '2018/11/4', 'PayPal', 'Purchase successful');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (808, 199, 103, '2018/3/10', 'PayPal', 'Purchase successful');
INSERT INTO "Purchases"(purchase_id, final_price, user_id, paid_date, payment_method, details) VALUES (809, 99, 104, '2018/9/2', 'Credit Card', 'Purchase successful');

-- Wishlists (user_id, product_id)
INSERT INTO "Wishlists"(user_id, product_id) VALUES (100, 209);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (101, 208);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (102, 207);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (103, 206);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (104, 205);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (105, 204);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (106, 203);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (107, 202);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (108, 201);
INSERT INTO "Wishlists"(user_id, product_id) VALUES (109, 200);

-- PurchasedKeys

INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (500, 800,32 );
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (501, 801, 53);
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (502, 802, 66);
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (503, 803,77 );
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (504, 804, 100);
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (505, 805,52 );
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (506, 806, 75);
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (507, 808,43 );
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (508, 807, 12);
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (509, 804, 32);
INSERT INTO "PurchasedKeys"(sk_id, purchase_id, price) VALUES (510, 803, 43);

--Queries--

--User's info:

SELECT * 
FROM "Users" 
WHERE "Users".username = $userName;

--Product's info:

SELECT * 
FROM "Products" 
WHERE "Products".product_id = $productId;

--User's Wishlist:

SELECT *
FROM "Products" 
INNER JOIN "Wishlists" ON "Wishlists".product_id = "Products".product_id
WHERE "Wishlists".user_id = $userId;

--User's Purchased Products:

SELECT *
FROM "Products"
WHERE "Products".product_id IN (
	SELECT DISTINCT product_id
	FROM (("PurchasedKeys"
	INNER JOIN "Purchases" ON "PurchasedKeys".purchase_id = "Purchases".purchase_id)
	INNER JOIN "SerialKeys" ON "PurchasedKeys".sk_id = "SerialKeys".sk_id)
	WHERE "Purchases".user_id = $userId
);

--Search for product by name or tag

SELECT * 
FROM "Products" 
WHERE "Products".name LIKE '%$search%' OR EXISTS (
	SELECT "Tags".tag_name
	FROM "Tags"
	WHERE "Products".product_id = "Tags".product_id AND "Tags".tag_name LIKE '%$search%'
) ORDER BY "Products".name ASC;

--Search for product reviews, including reviewer's ID

SELECT "Reviews".rating, "Reviews".comment, "Reviews".review_date, "Users".username, "Users".img, "Users".user_id
FROM (("Reviews"
INNER JOIN "SerialKeys" ON "SerialKeys".sk_id = "Reviews".sk_id)
INNER JOIN "Users" ON "SerialKeys".user_id = "Users".user_id)
WHERE "SerialKeys".product_id = $productId
ORDER BY "Reviews".rating DESC;

--Pre-login Handshake (through username, e-mail or phone number)

SELECT "Users".username, "Users".password
FROM "Users"
WHERE "Users".username = $idText OR "Users".email = $idText;

--Product's images:

SELECT "ProductImages".img_path 
FROM "ProductImages" 
WHERE "ProductImages".product_id = $productId;

--Get product's overall rating

SELECT AVG("Reviews".rating)
FROM "Reviews"
INNER JOIN "SerialKeys" ON "SerialKeys".sk_id = "Reviews".sk_id
WHERE "SerialKeys".product_id = $productId;

--Most Trending Products in the last "trendTime" days

SELECT *
FROM "Products"
WHERE "Products".product_id IN (
	SELECT product_id
	FROM (
	SELECT "SerialKeys".product_id, COUNT(*) 
	FROM (("PurchasedKeys"	
	INNER JOIN "SerialKeys" ON "PurchasedKeys".sk_id = "SerialKeys".sk_id)
	INNER JOIN "Purchases" ON "PurchasedKeys".purchase_id = "Purchases".purchase_id)
	WHERE "SerialKeys".product_id = "Products".product_id AND "Purchases".paid_date >= NOW() - INTERVAL '$trendTime day'
	GROUP BY "SerialKeys".product_id
	ORDER BY 2 DESC) AS DERP
)

-- Get product's with discounts

SELECT product_id 
FROM "Discounts" 
WHERE (CURRENT_DATE BETWEEN "Discounts".begin_date AND "Discounts".end_date);

--Triggers--



--Indexes--




```

 
## Revision history
 
Changes made to the first submission:
1. First submission
 
***
 
GROUP1744, 02/04/2018

- Guilherme dos Santos Amaro, up201508537@fe.up.pt
- João Alexandre Carvalho Marinho dos Santos, up201504013@fe.up.pt
- Pedro José Lourenço Azevedo, up201306026@fe.up.pt
- Nuno Manuel Ferreira Corte-Real, up201405158@fe.up.pt
